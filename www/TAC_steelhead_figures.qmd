---
title: "Track-a-Cohort: Steelhead"
date: "Last updated: `r Sys.Date()`"
format: html
output:
  html_document: 
   toc: true
   toc_float: true
   code_folding: true
   cache: true 
editor: visual
bibliography: ../www/refs/references.bib
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

## Objective

Using shared resources via [BDO github](https://github.com/BDO-Science/track-a-cohort) from BOR, replicate figures and adjust to include dynamic data. See [Track a cohort_Steelhead.docx](https://github.com/BDO-Science/track-a-cohort/blob/main/SH_Cohort/Track%20a%20Cohort_Steelhead.docx) for figures requested. Also consider future additions including more interactive capabilities to certain graphs in form of Rmarkdown and/or shinyapp

```{r, include=FALSE}
library(here)
source(here("R/load_dependencies.R"))

#set current year
source(here("R/utils_fct_assign_current_water_year.R"))
current_year <- assign_current_water_year()
```

## Figure 1. RBDD Juvenile Passage Estimates

```{r, load_plot_01, fig.width=10, fig.height=6}
source(here("R/steelhead_plot_rbdd_biweekly_passage.R"))
```

Related links: [SacPas Page](https://www.cbr.washington.edu/sacramento/tmp/redbluffdaily_1714603318_94.html), [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/winter_run_chinook_plot_annual_jpe.R)

-   Issues:
    -   Update biweekly shaded areas based on SI generated methods

## Figure 2. Survival and Routing Probabilites

Note: Using Winter-run Chinook as a surrogate for Steelhead

### Option 1: Facetted by year

```{r, load_plot_02, fig.width=12, fig.height=18 }
source(here("R/winter_run_chinook_plot_STARS.R"))
```

### Option 2: Without faceted years

```{r,  load_plot_02_alt, fig.width=12, fig.height=18}
source(here("R/winter_run_chinook_plot_STARS_withoutfacetedyears.R"))
```

Related links: [SacPas Page](pending), [Interactive Plot](https://csobrien.shinyapps.io/TAC_WRChinook_STARS/), [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/winter_run_chinook_plot_STARS.R), [STARS ShinyApp](https://www.cbr.washington.edu/shiny/STARS/)

## Figure 3. Comparison of Clipped and Unclipped Loss

### Figure 3a. Total Loss of Clipped and Unclipped Steelhead

```{r load_plot_03a, fig.width=10, fig.height=6}
source(here("R/steelhead_plot_count_total_loss.R"))
```

Related links: SacPas Page, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/steelhead_plot_count_total_loss.R)

### Figure 3b. Size Distribution of Loss

```{r load_plot_03b, fig.width=10, fig.height=6, fig.cap="Figure includes density plots that highlight historical (WY1994 to WY2023) size distribution and histogram of current year (WY2024) size distribution by rear type. Fork lengths below 750 mm were included in dataset."}
source(here("R/steelhead_plot_size_distribution_loss.R"))
```

Related links: SacPas Page, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/steelhead_plot_size_distribution_loss.R)

### Figure 3c. Size Distribution of Steelhead Loss By Year

```{r load_plot_03c, fig.width=6, fig.height=10}
source(here("R/steelhead_plot_size_distribution_by_year_loss.R"))
```

Related links: SacPas Page, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/steelhead_plot_size_distribution_by_year_loss.R)


## Figure 4. Cumulative Loss

```{r load_plot_04, fig.width=10, fig.height=10}
source(here("R/steelhead_plot_count_cumulative_loss.R"))
```

Related links: SacPas Page, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/steelhead_plot_count_cumulative_loss.R)

## Figure 5. Cumulative Loss with Single-Year Thresholds

```{r load_plot_05, fig.width=10, fig.height=6}
source(here("R/steehead_plot_count_cumulative_loss_single_year_thresholds.R"))
```

Related links: [SacPas Page](https://www.cbr.washington.edu/sacramento/workgroups/salmon_monitoring.html#loss:~:text=Chinook%20Salmon%20Loss-,Natural%20Central%20Valley%20Steelhead,-Daily%20Loss%20Table), ShinyApp,  [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/steehead_plot_count_cumulative_loss_single_year_thresholds.R)

- Issues: 
  - Confirm Single-Year-Thresholds and update to generate automatically
  - Confirm only including unclipped 
  
## Table 1. Minimization of Cumulative Loss of Hatchery Steelhead

\*Pending steelhead hatchery release information

```{r, load_table_01}
# Load the data
load(here("data/steelhead_loss_data.rda"))

#load function to wrangle into table format
source(here("R/steelhead_fct_generate_table_total_hatchery_loss.R"))

# generate HTML table
generate_table_steelhead_total_hatchery_loss(steelhead_loss_data)

```

Related links: SacPas Page, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/steelhead_fct_generate_table_total_hatchery_loss.R)


-   Issues:
    -   Update with steelhead hatchery release information when becomes available

## Figure 6. Daily Loss, Exports, and Pumping Rates by Facility

```{r, load_plot_06, fig.width=10, fig.height=6}
source(here("R/steelhead_plot_daily_loss_export.R"))
```

Related links: SacPas Page, ShinyApp, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/steelhead_plot_daily_loss_export.R)


-   Issues:
    -   Update with SacPas generated link for Export data per Facility, closest data found: <https://www.cbr.washington.edu/sacramento/tmp/juvloss_1719955580_301.html>, which is used in figure. Does not delineate between facility. Also, requires selection of current year, species and rear-type, and management year type. Update with query string that can pull current year data for steelhead.

## Figure 7. Tillotson Steelhead Loss



Related links: SacPas Page, [SacPas Tillotson Tool](https://www.cbr.washington.edu/sacramento/lossandsalvage/), GitHub Repo Code

-   Issues:
    -   Run model or pull Tillotson data from tool?

## Table 2. Predicted and Observed Loss

```{r, load_table_02}
# Load the data
load(here("data/steelhead_loss_export_data.rda"))

#load function to wrangle into table format
source(here("R/steelhead_fct_generate_table_predicted_observed_loss.R"))

# generate HTML table
generate_table_steelhead_pred_obs_loss(steelhead_loss_export_data)

```

Related links: SacPas Page, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/steelhead_fct_generate_table_predicted_observed_loss.R)
-   Issues:
    -   Confirm table uses unclipped for summary
    -   Identify methods used for predicted column
    -   Confirm table should include weekly? averages for current water year. How are averages calculated?
    -   Confirm OMR or OMRI is used, alternatively include both?
