---
title: "Track-a-Cohort: Winter-run Chinook"
date: "Last updated: `r Sys.Date()`"
format: html
output:
  html_document: 
   toc: true
   toc_float: true
   code_folding: true
   cache: true 
editor: visual
bibliography: ../www/refs/references.bib
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

## Background

This document uses shared resources via [BDO github](https://github.com/BDO-Science/track-a-cohort){target="_blank"} from BOR to replicate figures requested and adjust underlying code to include dynamic data. See [Track a cohort_WR_plots.docx](https://github.com/BDO-Science/track-a-cohort/blob/main/Track%20a%20Cohort_WR_plots.docx) for figures requested. Certain figures include a link to more interactive plot types using Shiny (in development) and all figures include a link to code in separate CBR developed [github repo](https://github.com/caitobrien/TAC){target="_blank"}.

```{r, include=FALSE}
library(here)
source(here("R/load_dependencies.R"))

#set current year
source(here("R/utils_fct_assign_current_water_year.R"))
current_year <- assign_current_water_year()
```

## Figure 1. Juvenile Production Estimate

```{r, load_plot_01, fig.width=10, fig.height=6}
source(here("R/winter_run_chinook_plot_annual_jpe.R"))
```

Related links: [SacPAS Page](https://www.cbr.washington.edu/sacramento/data/jpe_data.html){target="_blank"}, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/winter_run_chinook_plot_annual_jpe.R){target="_blank"}

-   Issues:
    -   Update genetic data as it becomes available
    -   Update method naming conventions as needed

## Figure 2. Survival and Routing Probabilites

```{r,  load_plot_02, fig.width=12, fig.height=18}
source(here("R/winter_run_chinook_plot_STARS.R"))
```

Related links: SacPAS Page, [Interactive Plot - ShinyApp](https://csobrien.shinyapps.io/WRChinookSTARS/){target="_blank"}, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/winter_run_chinook_plot_STARS.R){target="_blank"}, [STARS ShinyApp](https://www.cbr.washington.edu/shiny/STARS/){target="_blank"}

-   Issues:
    -   Update interactive plot to reflect choice of non faceted years

## Figure 3. Juvenile Production Estimate (JPE) – Percent Loss

### Figure 3a. Genetic vs Length-At-Date (LAD) Historical Percent Loss of JPE

```{r load_plot_03a, fig.width=10, fig.height=6}
source(here("R/winter_run_chinook_plot_pct_genetic_lad_loss_jpe.R"))
```

Related links: SacPAS Page, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/winter_run_chinook_plot_pct_genetic_lad_loss_jpe.R){target="_blank"}

### Figure 3b. Cumulative Genetic Percent Loss of JPE

```{r, load_plot_03b, fig.width=10, fig.height=6}
source(here("R/winter_run_chinook_plot_pct_cumulative_genetic_loss_jpe.R"))
```

Related links: SacPAS Page,[GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/winter_run_chinook_plot_pct_cumulative_genetic_loss_jpe.R){target="_blank"}, [Interactive Plot - ShinyApp](https://csobrien.shinyapps.io/CumulativeLoss/){target="\"_blank"}

-   Issues:
    -   Confirm use of Water Year over Brood Year in Fig 3a- both were used in word doc shared
    -   Update genetic data as it becomes available
    -   Confirm missing 2008 data
    -   Update method naming conventions as needed
    -   Confirm loss URL sourced from SacPAS, no age restriction added [url](https://www.cbr.washington.edu/sacramento/data/query_loss_detail.html)

## Figure 4. Juvenile Production Estimate (JPE) – Number Loss

### Figure 4a. Genetic vs Length-At-Date (LAD) Historical Loss of the JPE

```{r, load_plot4a, fig.width=10, fig.height=6}
source(here("R/winter_run_chinook_plot_count_genetic_lad_loss_jpe.R"))
```

Related links: SacPAS Page, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/winter_run_chinook_plot_count_genetic_lad_loss_jpe.R){target="_blank"}

### Figure 4b. Cumulative Length-At-Date (LAD) loss of the JPE

```{r, load_plot4b, fig.width=10, fig.height=10, fig.cap="The figure shows cumulative loss by BiOp Status and Hydrological Classification Index (HCI). Each quadrant of the faceted plot includes grey lines for historical years, colored lines (blue for wet years, red for dry years) for years within the BiOp status and HCI type, a black line for the current year, and a dashed horizontal line indicating the current cumulative loss maximum."}
source(here("R/winter_run_chinook_plot_count_cumulative_lad_loss_jpe.R"))
```

Related links: SacPAS Page, ShinyApp, [GitHub Repo Code](https://github.com/caitobrien/TAC/blob/main/R/winter_run_chinook_plot_count_cumulative_lad_loss_jpe.R){target="_blank"}, [Interactive Plot - ShinyApp](https://csobrien.shinyapps.io/CumulativeLoss/){target="\"_blank"}

-   Issues:
    -   Update genetic data as it becomes available
    -   Update method naming conventions as needed
    -   Confirm loss URL sourced from SacPAS, no age restriction added [url](https://www.cbr.washington.edu/sacramento/data/query_loss_detail.html)

## Figure 5. Single Year Thresholds

### Figure 5a. Cumulative Genetic Loss for Current Water Year

```{r, load_plot5a, fig.width=10, fig.height=6}
source(here("R/winter_run_chinook_plot_count_cumulative_genetic_loss_single_year_thresholds.R"))
```

### Figure 5b. Cumulative LAD Loss for Current Water Year

```{r, load_plot5b, fig.width=10, fig.height=6}
source(here("R/winter_run_chinook_plot_count_cumulative_lad_loss_single_year_thresholds.R"))
```

Related links: [SacPAS Page](https://www.cbr.washington.edu/sacramento/workgroups/salmon_monitoring.html#loss){target="_blank"}, ShinyApp, [GitHub Repo Code: cumul_genetic_loss](https://github.com/caitobrien/TAC/blob/main/R/winter_run_chinook_plot_count_cumulative_genetic_loss_single_year_thresholds.R){target="_blank"} , [GitHub Repo Code: cumul_lad_loss](https://github.com/caitobrien/TAC/blob/main/R/winter_run_chinook_plot_count_cumulative_lad_loss_single_year_thresholds.R){target="_blank"}, [Interactive Plot - ShinyApp](https://csobrien.shinyapps.io/CumulativeLossSingleYearThreshold/){target="\"_blank"}

-   Issues:
    -   Confirm loss URL sourced from SacPAS, no age restriction added [url](https://www.cbr.washington.edu/sacramento/data/query_loss_detail.html)
    -   Confirm single year threshold and naming conventions

## Figure 6. Predicted and Observed Weekly Loss - Tillotson Model

```{r, load_plot6, fig.width=10, fig.height=6}
source(here("R/winter_run_chinook_plot_tillotson_predicted_loss.R"))
```

Related links: SacPAS Page, [SacPAS Tillotson Tool](https://www.cbr.washington.edu/sacramento/lossandsalvage/){target="_blank"}, GitHub Repo Code: [Tillotson model](https://github.com/caitobrien/TAC/blob/main/data-raw/WR_Model_Setup.R){target="_blank"}, [data wrangling and prediction output](https://github.com/caitobrien/TAC/blob/main/data-raw/utils_fct_predict_tillotson_model.R){target="_black"}, [plot output](https://github.com/caitobrien/TAC/blob/main/R/winter_run_chinook_plot_tillotson_predicted_loss.R){target="_blank"}

-   Issues:
    -   Currently using BOR supplied code to run model, confirm same output with NB code.
        -   Update: NB believes this is updated code and will look into comparing and update Loss and Salvage Predictor Tool as needed when time allows (Estimates time in August).
    -   Confirm shared code is duplicate of the most up-to-date Tillotson code. If this is Tillotson code confirm with authors on use and confirm permissions to include model code in public facing repo. Alternatively, pull results from Loss and Salvage Predictor Tool.
        -   JG or NB to reach out?
    -   Confirm change in plot design

## Table 1. Model inputs and predictions - Tillotson Model

```{r, load_table_01, fig.width=10, fig.height=6}
# Load the data
load(here("data/tillotson_prediction_output.rda"))

data <- tillotson_prediction_output$winter_run_tillotson_output

#load function to wrangle into table format
source(here("R/utils_fct_generate_table_predicted_observed_loss.R"))

# generate HTML table
generate_table_pred_obs_loss(data, species = "Winter-run Chinook")

```

Related links: SacPAS Page,[SacPAS Tillotson Tool](https://www.cbr.washington.edu/sacramento/lossandsalvage/){target="_blank"}, GitHub Repo Code: [Tillotson model](https://github.com/caitobrien/TAC/blob/main/data-raw/Steelhead_Model_Setup.R){target="_blank"}, [data wrangling and prediction output](https://github.com/caitobrien/TAC/blob/main/data-raw/utils_fct_predict_tillotson_model.R){target="_black"}, [Table configuration](https://github.com/caitobrien/TAC/blob/main/R/utils_fct_generate_table_predicted_observed_loss.R){target="_blank"}

-   Issues:
    -   See Figure 6 issues
